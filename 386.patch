From 7ec377bb50fdb07465dc75779567319c7cf5a5fc Mon Sep 17 00:00:00 2001
From: heguanghao <heguanghao@thedream.cc>
Date: Thu, 16 Nov 2023 11:47:54 +0800
Subject: [PATCH 1/2] =?UTF-8?q?=E6=B7=BB=E5=8A=A0=E7=9B=B4=E6=8E=A5?=
 =?UTF-8?q?=E4=BF=9D=E5=AD=98=E4=B8=94=E4=B8=8D=E8=B7=B3=E8=BD=AC=E9=A1=B5?=
 =?UTF-8?q?=E9=9D=A2=E5=8A=9F=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 app/controllers/page.go   |  4 +++-
 static/js/modules/page.js | 18 +++++++++++++++---
 views/page/edit.html      |  3 ++-
 3 files changed, 20 insertions(+), 5 deletions(-)

diff --git a/app/controllers/page.go b/app/controllers/page.go
index 3468d465..bc87ac49 100644
--- a/app/controllers/page.go
+++ b/app/controllers/page.go
@@ -179,6 +179,8 @@ func (this *PageController) Modify() {
 	comment := strings.TrimSpace(this.GetString("comment", ""))
 	isNoticeUser := strings.TrimSpace(this.GetString("is_notice_user", "0"))
 	isFollowDoc := strings.TrimSpace(this.GetString("is_follow_doc", "0"))
+	// 保存类型
+	saveType := strings.TrimSpace(this.GetString("save_type", ""))
 
 	// rm document_page_editor-markdown-doc
 	this.Ctx.Request.PostForm.Del("document_page_editor-markdown-doc")
@@ -281,7 +283,7 @@ func (this *PageController) Modify() {
 	}(documentId)
 
 	this.InfoLog("修改文档 " + documentId + " 成功")
-	this.jsonSuccess("文档修改成功！", nil, "/document/index?document_id="+documentId)
+	this.jsonSuccess("文档修改成功！", saveType, "/document/index?document_id="+documentId)
 }
 
 // document share display
diff --git a/static/js/modules/page.js b/static/js/modules/page.js
index 8c7a6837..0dcb2007 100644
--- a/static/js/modules/page.js
+++ b/static/js/modules/page.js
@@ -9,7 +9,7 @@ var Page = {
      * @param element
      * @returns {boolean}
      */
-    ajaxSave: function (element, sendEmail, isAutoFollow) {
+    ajaxSave: function (element, sendEmail, isAutoFollow, isConfirm) {
 
         /**
          * 成功信息条
@@ -45,7 +45,7 @@ var Page = {
                 Storage.remove(storageId);
                 successBox(result.message, result.data);
             }
-            if (result.redirect.url) {
+            if (result.redirect.url && result.data == "0") {
                 var sleepTime = result.redirect.sleep || 3000;
                 setTimeout(function () {
                     parent.location.href = result.redirect.url;
@@ -53,6 +53,18 @@ var Page = {
             }
         }
 
+        // 直接保存
+        if(isConfirm == false){
+            var commentText = ""
+            var options = {
+                dataType: 'json',
+                success: response,
+                data: {'comment': commentText, 'is_notice_user': "0", 'is_follow_doc': "1", 'save_type':"1"}
+            };
+            $(element).ajaxSubmit(options);
+            return false;
+        }
+
         var containerHtml = '<div class="container-fluid" style="padding: 20px 20px 0 20px">';
         containerHtml += '<textarea name="edit_comment" class="form-control" rows="3" autofocus="autofocus" style="resize:none""></textarea>';
         containerHtml += '<div style="margin-top: 8px;text-align: left">';
@@ -95,7 +107,7 @@ var Page = {
                     var options = {
                         dataType: 'json',
                         success: response,
-                        data: {'comment': commentText, 'is_notice_user': isNoticeUser, 'is_follow_doc': isFollowDoc}
+                        data: {'comment': commentText, 'is_notice_user': isNoticeUser, 'is_follow_doc': isFollowDoc, 'save_type':"0"}
                     };
                     $(element).ajaxSubmit(options);
                 }
diff --git a/views/page/edit.html b/views/page/edit.html
index 07bd2556..29a03382 100644
--- a/views/page/edit.html
+++ b/views/page/edit.html
@@ -8,7 +8,8 @@
                     <input type="text" name="name" class="form-control" placeholder="请输入文档名称" value="{{$document.name}}" {{if eq $document.parent_id "0"}} readonly="readonly" {{end}}>
                 </div>
                 <div class="col-md-2 text-center" >
-                    <button type="button" class="btn btn-primary" onclick="Page.ajaxSave(this.form, {{.sendEmail}}, {{.autoFollowDoc}})"><i class="fa fa-save"></i> 保存</button>
+                    <button type="button" class="btn btn-primary" onclick="Page.ajaxSave(this.form, {{.sendEmail}}, {{.autoFollowDoc}}, true)"><i class="fa fa-save"></i> 确认保存</button>
+                    <button type="button" class="btn btn-primary" onclick="Page.ajaxSave(this.form, {{.sendEmail}}, {{.autoFollowDoc}}, false)"><i class="fa fa-save"></i> 直接保存</button>
                     <button type="button" class="btn btn-default" onclick="Page.cancelSave('确定要放弃此次修改吗?', '/document/index?document_id={{$document.document_id}}')"><i class="fa fa-mail-reply"></i> 取消</button>
                 </div>
             </div>

From 8eb7accd5a3987195057946704247441f8ffe2f0 Mon Sep 17 00:00:00 2001
From: heguanghao <heguanghao@thedream.cc>
Date: Thu, 16 Nov 2023 18:32:17 +0800
Subject: [PATCH 2/2] =?UTF-8?q?=E5=A2=9E=E5=8A=A0=20Ctrl=20+=20S=20?=
 =?UTF-8?q?=E4=BF=9D=E5=AD=98=E5=8A=9F=E8=83=BD?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

---
 views/page/edit.html | 10 ++++++++++
 1 file changed, 10 insertions(+)

diff --git a/views/page/edit.html b/views/page/edit.html
index 29a03382..5fa91b57 100644
--- a/views/page/edit.html
+++ b/views/page/edit.html
@@ -23,6 +23,16 @@
     </form>
 </div>
 <script type="text/javascript">
+    document.addEventListener("keydown", function(e) {
+        if (e.keyCode == 83 && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)) {
+            e.preventDefault();
+            // 你的处理逻辑
+            console.log('Ctrl+S event captured!');
+            var form = document.getElementById("page_form");
+            Page.ajaxSave(form, {{.sendEmail}}, {{.autoFollowDoc}}, false);
+        }
+    }, false);
+    
     if(parent.layoutClose) {
         parent.layoutClose();
     }
